version: '3.5'

services:
  regression:
    image: ${TARGET_REPO}/pytest:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/test/Dockerfile
      cache_from:
        - ${SOURCE_REPO}/pytest:${SOURCE_TAG}
    volumes:
      - ../../..:/milvus-distributed:delegated
    working_dir: "/milvus-distributed/tests/python"
    command: >
      /bin/bash -c "pytest --ip proxynode -n 4"
    networks:
      - milvus

  regression_distributed:
    image: ${TARGET_REPO}/pytest:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/test/Dockerfile
      cache_from:
        - ${SOURCE_REPO}/pytest:${SOURCE_TAG}
    volumes:
      - ../../..:/milvus-distributed:delegated
    working_dir: "/milvus-distributed/tests/python_test"
    command: >
      /bin/bash -c "sleep 10s && pytest -s --tags=0331 --ip proxynode -n 4"
    networks:
      - milvus

  regression_standalone:
    image: ${TARGET_REPO}/pytest:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/test/Dockerfile
      cache_from:
        - ${SOURCE_REPO}/pytest:${SOURCE_TAG}
    volumes:
      - ../../..:/milvus-distributed:delegated
    working_dir: "/milvus-distributed/tests/python_test"
    command: >
      /bin/bash -c "sleep 10s && pytest -s --tags=0331 --ip standalone -n 4"
    networks:
      - milvus

networks:
  milvus:
