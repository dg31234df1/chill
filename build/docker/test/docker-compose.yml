version: '3.5'

services:
  regression_distributed:
    image: ${TARGET_REPO}/pytest:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/test/Dockerfile
      cache_from:
        - ${SOURCE_REPO}/pytest:${SOURCE_TAG}
    volumes:
      - ../../..:/milvus-distributed:delegated
    working_dir: "/milvus-distributed/tests/python_test"
    command: >
      /bin/bash -c "sleep 10s && pytest --tags=0331 --reruns=1 -n 4 --ip proxynode"
    networks:
      - milvus

  regression_standalone:
    image: ${TARGET_REPO}/pytest:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/test/Dockerfile
      cache_from:
        - ${SOURCE_REPO}/pytest:${SOURCE_TAG}
    volumes:
      - ../../..:/milvus-distributed:delegated
    working_dir: "/milvus-distributed/tests/python_test"
    command: >
      /bin/bash -c "sleep 10s && pytest --tags=0331 --reruns=1 -n 4 --ip standalone"
    networks:
      - milvus

networks:
  milvus:
