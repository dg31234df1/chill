version: '3.5'

services:
  master:
    image: ${TARGET_REPO}/master:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/master/DockerFile
      cache_from:
        - ${SOURCE_REPO}/master:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      INDEX_SERVICE_ADDRESS: ${INDEX_SERVICE_ADDRESS}
    networks: 
      - milvus

  proxyservice:
    image: ${TARGET_REPO}/proxyservice:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/proxyservice/DockerFile
      cache_from:
        - ${SOURCE_REPO}/proxyservice:${SOURCE_TAG}
    networks:
      - milvus

  proxynode:
    image: ${TARGET_REPO}/proxynode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/proxynode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/proxynode:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      PROXY_NODE_HOST: ${PROXY_NODE_HOST}
      PROXY_SERVICE_ADDRESS: ${PROXY_SERVICE_ADDRESS}
    networks:
      - milvus

  queryservice:
    image: ${TARGET_REPO}/queryservice:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/queryservice/DockerFile
      cache_from:
        - ${SOURCE_REPO}/queryservice:${SOURCE_TAG}
    environment:
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

  querynode:
    image: ${TARGET_REPO}/querynode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/querynode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/querynode:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

  # writenode:
  #   image: ${TARGET_REPO}/writenode:${TARGET_TAG}
  #   build:
  #     context: ../../../
  #     dockerfile: build/docker/deploy/writenode/DockerFile
  #     cache_from:
  #       - ${SOURCE_REPO}/writenode:${SOURCE_TAG}
  #   environment:
  #     PULSAR_ADDRESS: ${PULSAR_ADDRESS}
  #     ETCD_ADDRESS: ${ETCD_ADDRESS}
  #     MASTER_ADDRESS: ${MASTER_ADDRESS}
  #     MINIO_ADDRESS: ${MINIO_ADDRESS}
  #   networks:
  #     - milvus

  datanode:
    image: ${TARGET_REPO}/datanode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/datanode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/datanode:${SOURCE_TAG}
    environment: 
      PULSAR_ADDRESS: ${PULSAR_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

  indexservice:
    image: ${TARGET_REPO}/indexservice:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/indexservice/DockerFile
      cache_from:
        - ${SOURCE_REPO}/indexservice:${SOURCE_TAG}
    environment:
      MASTER_ADDRESS: ${MASTER_ADDRESS}
      ETCD_ADDRESS: ${ETCD_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    networks:
      - milvus

  indexnode:
    image: ${TARGET_REPO}/indexnode:${TARGET_TAG}
    build:
      context: ../../../
      dockerfile: build/docker/deploy/indexnode/DockerFile
      cache_from:
        - ${SOURCE_REPO}/indexnode:${SOURCE_TAG}
    environment:
      INDEX_SERVICE_ADDRESS: ${INDEX_SERVICE_ADDRESS}
      MINIO_ADDRESS: ${MINIO_ADDRESS}
    depends_on:
      - "indexservice"
    networks:
      - milvus

networks:
  milvus:
